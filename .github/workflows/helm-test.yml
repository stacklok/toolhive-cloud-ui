name: Helm Chart Test

on:
    push:
        branches: [main]
        paths:
            - "helm/**"
            - ".github/workflows/helm-test.yml"
    pull_request:
        branches: [main]
        paths:
            - "helm/**"
            - ".github/workflows/helm-test.yml"

permissions:
    contents: read

jobs:
    test-helm-chart:
        name: Test Helm Chart
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

            - name: Build Docker image
              uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
              with:
                  context: .
                  load: true
                  tags: toolhive-cloud-ui:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Create Kind cluster
              uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0

            - name: Load image into Kind
              run: |
                  kind load docker-image toolhive-cloud-ui:latest --name chart-testing

            - name: Install Helm chart
              run: |
                  helm upgrade --install toolhive-cloud-ui ./helm \
                    -f ./helm/values-dev.yaml \
                    --wait \
                    --timeout=5m

            - name: Check deployment status
              run: |
                  kubectl get pods -l app.kubernetes.io/name=toolhive-cloud-ui
                  kubectl get svc -l app.kubernetes.io/name=toolhive-cloud-ui

            - name: Verify application is responding
              run: |
                  kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=toolhive-cloud-ui --timeout=120s
                  kubectl port-forward svc/toolhive-cloud-ui 8080:80 &
                  sleep 5
                  curl -f http://localhost:8080 || (kubectl logs -l app.kubernetes.io/name=toolhive-cloud-ui && exit 1)

            - name: Run Helm tests (if any)
              run: |
                  helm test toolhive-cloud-ui || echo "No tests defined"

            - name: Show logs on failure
              if: failure()
              run: |
                  kubectl get all -l app.kubernetes.io/name=toolhive-cloud-ui
                  kubectl describe pods -l app.kubernetes.io/name=toolhive-cloud-ui
                  kubectl logs -l app.kubernetes.io/name=toolhive-cloud-ui --tail=100
