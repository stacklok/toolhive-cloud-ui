name: Ollama POC

on:
  workflow_dispatch: # Manual trigger only for POC
  pull_request:
    paths:
      - ".github/workflows/ollama-poc.yml" # Only run when this file changes

permissions:
  contents: read

env:
  # Use a known path for models so we can cache them (v2)
  OLLAMA_MODELS: /home/runner/.ollama/models

jobs:
  ollama-benchmark:
    name: Ollama Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Cache Ollama binary
        id: cache-ollama
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/ollama
          key: ollama-binary-v0.13.5

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: /home/runner/.ollama/models
          key: ollama-qwen2.5-1.5b-v3

      - name: Install Ollama
        if: steps.cache-ollama.outputs.cache-hit != 'true'
        run: |
          echo "::group::Installing Ollama"
          START=$(date +%s)
          curl -fsSL https://ollama.com/install.sh | sh
          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è Ollama install time: $((END-START)) seconds"

      - name: Start Ollama server
        run: |
          # Stop the system service if running (may not exist if we skipped install)
          sudo systemctl stop ollama 2>/dev/null || true
          # Start with our custom model path
          OLLAMA_MODELS=/home/runner/.ollama/models ollama serve &
          sleep 3

      - name: Pull model
        run: |
          echo "::group::Pulling qwen2.5:1.5b"
          START=$(date +%s)
          OLLAMA_MODELS=/home/runner/.ollama/models ollama pull qwen2.5:1.5b
          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è Model pull time: $((END-START)) seconds (should be ~0 if cached)"

      - name: Debug - Check model location
        run: |
          echo "Models directory contents:"
          ls -la /home/runner/.ollama/models/ || echo "Directory doesn't exist"
          echo ""
          echo "Disk usage:"
          du -sh /home/runner/.ollama/models/ || echo "Can't measure"

      - name: Test simple generation
        run: |
          echo "::group::Simple generation test"
          START=$(date +%s)
          OLLAMA_MODELS=/home/runner/.ollama/models ollama run qwen2.5:1.5b "Say 'Hello, CI!' and nothing else."
          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è Simple generation time: $((END-START)) seconds"

      - name: Test tool calling capability
        run: |
          echo "::group::Tool calling test"
          START=$(date +%s)

          RESPONSE=$(OLLAMA_MODELS=/home/runner/.ollama/models ollama run qwen2.5:1.5b "You have access to a tool called 'get_weather' that takes a 'city' parameter. The user asks: 'What is the weather in Paris?' Respond ONLY with a JSON tool call like: {\"tool\": \"get_weather\", \"parameters\": {\"city\": \"Paris\"}}")

          END=$(date +%s)
          echo "Response: $RESPONSE"
          echo "::endgroup::"
          echo "‚è±Ô∏è Tool-style generation time: $((END-START)) seconds"

          if echo "$RESPONSE" | grep -q "get_weather"; then
            echo "‚úÖ Model understood tool calling format"
          else
            echo "‚ö†Ô∏è Model response didn't match expected tool format"
          fi

      - name: Test multiple quick generations
        run: |
          echo "::group::Multiple generation benchmark"
          START=$(date +%s)

          for i in 1 2 3 4 5; do
            echo "--- Run $i ---"
            OLLAMA_MODELS=/home/runner/.ollama/models ollama run qwen2.5:1.5b "Reply with only: Response $i" 2>/dev/null
          done

          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è 5 generations total time: $((END-START)) seconds"
          echo "‚è±Ô∏è Average per generation: $(( (END-START) / 5 )) seconds"

      - name: Print summary
        run: |
          echo ""
          echo "=========================================="
          echo "üìä OLLAMA POC SUMMARY"
          echo "=========================================="
          echo "Model: qwen2.5:1.5b"
          echo "Runner: ubuntu-latest"
          echo ""
          echo "This POC demonstrates that Ollama can run"
          echo "in GitHub Actions for E2E AI testing."
          echo ""
          echo "Next steps if timings are acceptable:"
          echo "1. Add AI SDK integration with Ollama provider"
          echo "2. Create mock-free E2E tests for assistant"
          echo "3. Merge into main E2E workflow"
          echo "=========================================="
