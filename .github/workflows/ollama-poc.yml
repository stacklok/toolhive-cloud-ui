name: Ollama POC

on:
  workflow_dispatch: # Manual trigger only for POC
  pull_request:
    paths:
      - ".github/workflows/ollama-poc.yml" # Only run when this file changes

permissions:
  contents: read

env:
  # Use a known path for models so we can cache them
  OLLAMA_MODELS: /home/runner/.ollama/models

jobs:
  ollama-benchmark:
    name: Ollama Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Cache Ollama binary
        id: cache-ollama
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/ollama
          key: ollama-binary-v0.13.5

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: /home/runner/.ollama/models
          key: ollama-qwen2.5-1.5b-v3

      - name: Install Ollama
        if: steps.cache-ollama.outputs.cache-hit != 'true'
        run: |
          echo "::group::Installing Ollama"
          START=$(date +%s)
          curl -fsSL https://ollama.com/install.sh | sh
          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è Ollama install time: $((END-START)) seconds"

      - name: Start Ollama server
        run: |
          # Stop the system service if running (may not exist if we skipped install)
          sudo systemctl stop ollama 2>/dev/null || true
          # Start with our custom model path
          OLLAMA_MODELS=/home/runner/.ollama/models ollama serve &
          sleep 3

      - name: Pull model
        run: |
          echo "::group::Pulling qwen2.5:1.5b"
          START=$(date +%s)
          OLLAMA_MODELS=/home/runner/.ollama/models ollama pull qwen2.5:1.5b
          END=$(date +%s)
          echo "::endgroup::"
          echo "‚è±Ô∏è Model pull time: $((END-START)) seconds (should be ~0 if cached)"

      - name: Debug - Check model location
        run: |
          echo "Models directory contents:"
          ls -la /home/runner/.ollama/models/ || echo "Directory doesn't exist"
          echo ""
          echo "Disk usage:"
          du -sh /home/runner/.ollama/models/ || echo "Can't measure"

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Assistant E2E tests with Ollama
        run: pnpm test:e2e tests/e2e/assistant.spec.ts
        env:
          USE_OLLAMA: "true"
          OLLAMA_MODEL: qwen2.5:1.5b
          OLLAMA_BASE_URL: http://localhost:11434
          API_BASE_URL: http://localhost:9090
          OIDC_ISSUER_URL: http://localhost:4000
          OIDC_CLIENT_ID: test-only-not-a-real-id
          OIDC_CLIENT_SECRET: test-only-not-a-real-secret
          NEXT_PUBLIC_OIDC_PROVIDER_ID: oidc
          BETTER_AUTH_URL: http://localhost:3000
          BETTER_AUTH_SECRET: test-only-not-a-real-better-auth-secret

      - name: Upload test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: failure()
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Print summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä OLLAMA E2E TEST SUMMARY"
          echo "=========================================="
          echo "Model: qwen2.5:1.5b"
          echo "Runner: ubuntu-latest"
          echo ""
          echo "This workflow runs E2E tests for the"
          echo "assistant feature using Ollama for"
          echo "deterministic, API-key-free testing."
          echo "=========================================="
