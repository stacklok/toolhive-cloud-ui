# ToolHive Cloud UI - Docker Compose Configuration
#
# Extends toolhive-registry-server docker-compose with the UI frontend.
#
# Prerequisites:
#   Clone the registry-server repo in the same parent directory:
#   git clone https://github.com/stacklok/toolhive-registry-server.git ../toolhive-registry-server
#
# Usage:
#   # Option 1: Create .env file with your config
#   # OIDC_ISSUER_URL=https://your-org.okta.com
#   # OIDC_CLIENT_ID=your-client-id
#   # OIDC_CLIENT_SECRET=your-client-secret
#   # OIDC_PROVIDER_ID=okta
#   # BETTER_AUTH_SECRET=your-secret
#   # API_BASE_URL=http://toolhive-registry-api:8080  (optional, default shown)
#   docker compose up --build
#
#   # Option 2: With mock OIDC (no .env needed):
#   docker compose --profile mock up --build
#
# Access:
#   - UI: http://localhost:3000
#   - API: http://localhost:8080 (from registry-server)
#   - OIDC Mock (if using --profile mock): http://localhost:4000

include:
  - path: ../toolhive-registry-server/docker-compose.yaml

services:
  # Optional: OIDC mock for local development (use --profile mock)
  oidc-mock:
    profiles:
      - mock
    build:
      context: ./dev-auth
      dockerfile: Dockerfile
    container_name: toolhive-oidc-mock
    ports:
      - "4000:4000"
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      - OIDC_ISSUER_URL=http://localhost:4000
    networks:
      - registry-network
    restart: unless-stopped

  cloud-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: toolhive-cloud-ui
    depends_on:
      - registry-api
    ports:
      - "3000:3000"
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      # Backend API URL (internal Docker network)
      - API_BASE_URL=http://toolhive-registry-api:8080
      #
      # SECURITY NOTE: Default values below are for LOCAL DEVELOPMENT ONLY.
      # For production, always provide these via .env file with secure values.
      #
      # Better Auth configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-docker-compose-dev-secret-change-in-production}
      - BETTER_AUTH_URL=http://localhost:3000
      # OIDC configuration
      # For Okta: set OIDC_ISSUER_URL, OIDC_CLIENT_ID, OIDC_CLIENT_SECRET in .env
      # For mock: use --profile mock and defaults will work
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-http://localhost:4000}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-better-auth-dev}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-dev-secret-change-in-production}
      - OIDC_PROVIDER_ID=${OIDC_PROVIDER_ID:-okta}
    networks:
      - registry-network
    restart: unless-stopped
